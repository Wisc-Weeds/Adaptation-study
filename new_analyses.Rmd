---
title: "new_analses"
author: "Maxwel Coura Oliveira"
date: "6/7/2021"
output: html_document
---


```{r}
library(tidyverse)
library(lubridate)
library(drc)
library(broom)
library(tidytext)
library(ggthemes)
```


```{r}
data <- read_csv("data2.csv")
```


```{r}
data %>% 
  filter(location != "grant") -> data1
```

```{r}
data1 %>% 
  rename(month = planting,
         planting = planting_1) %>% 
  mutate(planting = mdy(planting),
         harvest = mdy(harvest),
         doyp = yday(planting)) %>% 
  mutate_if(is_character, as_factor) -> data2
```


```{r}
data2 %>% 
  mutate(harvest = as.character(harvest)) %>% 
  mutate(harvest = str_replace(harvest, "2018", "2019"),
         harvest = ymd(harvest)) %>% 
  filter(!is.na(harvest)) %>% 
  dplyr::select(location, month, crop, harvest) %>% 
  group_by(location, month, crop) %>% 
  count(harvest, name = "harvest_day") -> harvest
```


```{r}
data2 %>% 
  filter(!is.na(harvest)) %>% 
  dplyr::select(location, month, crop, harvest) %>% 
  group_by(location, month, crop) %>% 
  count(location, month, crop, name = "total") -> total
```


```{r}
total %>% 
  left_join(harvest) %>% 
  mutate(prop = harvest_day / total) %>% 
  mutate(lag = lag(prop)) %>% 
  mutate(prob = cumsum(prop)) -> cum_sum
```



```{r}
data2 %>% 
  mutate(harvest = str_replace(harvest, "2018", "2019"),
         harvest = ymd(harvest)) %>% 
  filter(!is.na(harvest)) %>% 
  left_join(cum_sum) %>% 
  rename(harvest_com = harvest) %>% 
  dplyr::select(-lag) -> data3
```


```{r}
data3 %>% 
  ggplot(aes(x = dap, y = prob, color = crop)) +
  geom_point() +
  facet_grid(location ~ month)
```
```{r}
car::leveneTest(prob ~ location, data = data3)
```

```{r}
data3 %>% 
  unite("trt", c("location", "crop"), sep = "-") -> data4
```


# June

```{r}
june <-  data4 %>% 
  filter(month == "June")
model <- drm(prob*100 ~ doyh, trt, fct = W2.3(fixed = c(NA, 100, NA)), data = june)

plot(model, col = c(1,2,3), type = "average", ylab = "Cumulative flowering (%)",
     xlab = "Day of the year")
```
```{r}
#broom::tidy(model_arl)
summary(model)
```

```{r}
ed_values <- ED(model, c(10, 50, 90), interval = "delta", type = "absolute")
```

```{r}
ed_values %>% 
  as.data.frame() %>% 
  rownames_to_column(., var = "name") %>% 
  as_tibble() %>% 
  separate(name, c("param", "trt", "ED"), sep = ":") %>% 
  janitor::clean_names() -> ed_values1
```


```{r}
ed_values1 %>% 
  mutate_if(is_character, as_factor) %>% 
  mutate(trt = reorder_within(trt, by = estimate, within = ed)) %>% 
  ggplot(aes(x = trt, y = estimate)) +
  scale_x_reordered() +
  geom_point() +
  geom_linerange(aes(ymin = lower, ymax = upper)) +
  labs(y = NULL, x = NULL,
       title = "DOY of 10, 50, and 90% Palmer amaranth flowering") +
  coord_flip() +
#  scale_color_brewer(palette = "Paired") +
  facet_wrap(~ ed, scales = "free") +
  theme_bw() +
  theme(legend.position = "none") +
  ggsave("june.png", width = 12, height = 5)
```





# July

```{r}
july <-  data4 %>% 
  filter(month == "July")
model1 <- drm(prob*100 ~ doyh, trt, fct = W2.3(fixed = c(NA, 100, NA)), data = july)

plot(model1, col = c(1,2,3), type = "average", ylab = "Cumulative flowering (%)",
     xlab = "Day of the year")
```


```{r}
#broom::tidy(model_arl)
summary(model1)
```

```{r}
ed_values <- ED(model1, c(10, 50, 90), interval = "delta", type = "absolute")
```

